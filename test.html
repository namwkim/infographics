
<!DOCTYPE html>
<html>
<head>
<title>Infographics Generator</title>
<link rel="stylesheet" type="text/css" href="./stylesheets/style.css">  
<link href='http://fonts.googleapis.com/css?family=Alegreya' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Roboto+Condensed' rel='stylesheet' type='text/css'>
<link href='./stylesheets/nv.d3.css' rel='stylesheet' type='text/css'>
<style>

#chart svg {
  height: 400px;
}

</style>
<script src="http://code.jquery.com/jquery-2.1.1.js"></script>
<script src="http://d3js.org/d3.v3.js" charset="utf-8"></script>
<script src="./javascripts/nv.d3.js" charset="utf-8"></script>
<script type="text/javascript">
var analystEst;
var keyStats;
var histData;
var incomeStat;
$(document).ready(function(){
	var symbol 	= 'GOOGL';
	var name 	= "Google";

	var curMonth= (new Date()).getMonth();
	var curDate = (new Date()).getDate();
	var curYear = (new Date()).getFullYear();

	// ANALYSIS ESTIMATES

	var yql_base_uri = "http://query.yahooapis.com/v1/public/yql?";
	var yql_query = "SELECT * FROM yahoo.finance.analystestimate WHERE symbol='"+symbol+"'";  
	
	var dfrd = runQuery(yql_base_uri, yql_query, function(res){
		analystEst = res.query.results.results;
		console.log('ANALYSIS ESTIMATES')
		console.log(analystEst);
	})

	// KEY STATISTICS
	yql_query = "SELECT * FROM yahoo.finance.keystats WHERE symbol='"+symbol+"'"; 

	dfrd = dfrd.then(runQuery(yql_base_uri, yql_query, function(res){
		keyStats = res.query.results.stats;
		console.log('KEY STATISTICS')
		console.log(keyStats);		
	}))

	//INCOME STATEMENT
	yql_query = "SELECT * FROM yahoo.finance.incomestatement WHERE symbol='"+symbol+"'"; 

	dfrd = dfrd.then(runQuery(yql_base_uri, yql_query, function(res){
		incomeStat = res.query.results.incomestatement.statement;
		console.log('INCOME STATEMENT')
		console.log(incomeStat);		
	}))	

	// HISTORICAL DATA (LAST YEAR)
	var startDate 	= constructQueryDate(curYear-1, curMonth, curDate);
	var endDate		= constructQueryDate(curYear, curMonth, curDate);
	yql_query = "select * from yahoo.finance.historicaldata(0) where symbol = '"+symbol+"' and startDate = '"+startDate+"' and endDate = '"+endDate+"'";
	dfrd = dfrd.then(runQuery(yql_base_uri, yql_query, function(res){
		histData = res.query.results.quote;
		for (var i in histData){
			histData[i].Adj_Close 	= parseFloat(histData[i].Adj_Close);
			histData[i].Close 		= parseFloat(histData[i].Close);
			histData[i].High 		= parseFloat(histData[i].High);
			histData[i].Open 		= parseFloat(histData[i].Open);
			histData[i].Low 		= parseFloat(histData[i].Low);
			histData[i].Volume 		= parseFloat(histData[i].Volume); 
		}
		console.log('HISTORICAL DATA')
		console.log(histData);		
	})).then(function(){

		// GENERATE GRAPHICS
		var w = 800;
		var h = 1200;
		var x = 10;
		var y = 60;
		var report = d3.select(".report").style("background-color", "#ffffff");

		var svg = report.append("svg")
			.attr("width", w)
			.attr("height", h);
		var curEpsQtrGrowth = parsePercent(analystEst.GrowthEst.CurrentQtr[symbol])
		if (curEpsQtrGrowth>0){
			titleText = name + " Earnings Expected to Rise"
		}else{
			titleText = name + " Profit Expected to Fall";		
		}
		var title = svg.append("text")
			.attr("x", x)
			.attr("y", y)
			.text(titleText)
			.attr("font-family", "'Alegreya', serif")
			.attr("font-size", "48px")
			.attr("font-weight", "bold")
			.attr("fill", "#2e3436");

		var epsQtrEst = parseFloat(analystEst.EarningsEst.AvgEstimate.CurrentQtr);
		var epsYrEst = parseFloat(analystEst.EarningsEst.AvgEstimate.CurrentYear)
		var epsQtrYrAgo = parseFloat(analystEst.EarningsEst.YearAgoEPS.CurrentQtr);
		var epsYrYrAgo = parseFloat(analystEst.EarningsEst.YearAgoEPS.CurrentYear);

		var curRevQtrGrowth = parsePercent(analystEst.RevenueEst.SalesGrowth.CurrentQtr);
		var revQtrEst = parsePercent(analystEst.RevenueEst.AvgEstimate.CurrentQtr);
		var revYrEst  = parsePercent(analystEst.RevenueEst.AvgEstimate.CurrentYear);
		var revQtrYrAgo = parsePercent(analystEst.RevenueEst.YearAgoSales.CurrentQtr);
		var revYrYrAgo = parsePercent(analystEst.RevenueEst.YearAgoSales.CurrentYear);

		// Revenue decrease or increase?
		y += 50;

		var highlightText;
		if (curEpsQtrGrowth){
			highlightText = "Analysts project a profit of $" + epsQtrEst + " a share, a rise from $" + epsQtrYrAgo + " per share a year ago";
		}else{
			highlightText = "Analysts project profit to drop from $"+epsYrYrAgo+" year-over-year to $"+ epsQtrEst+" per share.";
		}
		var highlight = svg.append("text")
			.attr("x", x)
			.attr("y", y)
			.text(highlightText)
			.attr("font-size", "18px")
			.attr("fill", "#2e3436");

		// FIRST LAYER
		y += 50;

		var firstLayer = svg.append("g");

		var firstCol 	= firstLayer.append("svg")
			.attr("x", x)
			.attr("y", y)
			.attr("width", 250)
			.attr("height", 250);

		var iconlink = "./icons/increase.svg";
		if (epsQtrEst<epsQtrYrAgo){
			iconlink = "./icons/decrease.svg";
		}
		firstCol.append("text")
			.attr("x", 0)
			.attr("y", 20)
			.text("EPS Estimate")
			.attr("font-family", "'Roboto Condensed', sans-serif")
			.attr("font-size", "24px")
			.attr("fill", "#2e3436");	

		firstCol.append("image")
			.attr("x", 20)
			.attr("y", 30)
			.attr("width", 100)
			.attr("height", 100)
			.attr("xlink:href", iconlink);
		firstCol.append("text")
			.attr("x", 0)
			.attr("y", 150)
			.text("$" + epsQtrYrAgo+" \u2192 "+"$"+ epsQtrEst + "("+curEpsQtrGrowth+"%)")
			.attr("font-family", "'Roboto Condensed', sans-serif")
			.attr("font-size", "20px")
			.attr("fill", "#2e3436");

		var secondCol 	= firstLayer.append("svg")
			.attr("x", x+250)
			.attr("y", y)
			.attr("width", 250)
			.attr("height", 250);


		var iconlink = "./icons/increase.svg";
		if (revQtrEst<revQtrYrAgo){
			iconlink = "./icons/decrease.svg";
		}
		secondCol.append("text")
			.attr("x", 0)
			.attr("y", 20)
			.text("Revenue Estimate")
			.attr("font-family", "'Roboto Condensed', sans-serif")
			.attr("font-size", "24px")
			.attr("fill", "#2e3436");	

		secondCol.append("image")
			.attr("x", 20)
			.attr("y", 30)
			.attr("width", 100)
			.attr("height", 100)
			.attr("xlink:href", iconlink);
		secondCol.append("text")
			.attr("x", 0)
			.attr("y", 150)
			.text("$" + revQtrYrAgo+"B \u2192 "+"$"+ revQtrEst + "B ("+curRevQtrGrowth+"%)")
			.attr("font-family", "'Roboto Condensed', sans-serif")
			.attr("font-size", "20px")
			.attr("fill", "#2e3436");		

		var thirdCol 	= firstLayer.append("svg")
			.attr("x", x+500)
			.attr("y", y)
			.attr("width", 250)
			.attr("height", 250);

		thirdCol.append("text")
			.attr("x", 0)
			.attr("y", 20)
			.text("Fiscal-Year Estimate")
			.attr("font-family", "'Roboto Condensed', sans-serif")
			.attr("font-size", "24px")
			.attr("fill", "#2e3436");	

		thirdCol.append("image")
			.attr("x", 20)
			.attr("y", 30)
			.attr("width", 40)
			.attr("height", 40)
			.attr("xlink:href", "./icons/money1.svg");

		thirdCol.append("text")
			.attr("x", 70)
			.attr("y", 50)
			.text("$" + epsYrEst+" Per Share")
			.attr("font-family", "'Roboto Condensed', sans-serif")
			.attr("font-size", "20px")
			.attr("fill", "#2e3436");	

		thirdCol.append("image")
			.attr("x", 20)
			.attr("y", 80)
			.attr("width", 40)
			.attr("height", 40)
			.attr("xlink:href", "./icons/money2.svg");

		thirdCol.append("text")
			.attr("x", 70)
			.attr("y", 110)
			.text("$" + revYrEst+" Billion")
			.attr("font-family", "'Roboto Condensed', sans-serif")
			.attr("font-size", "20px")
			.attr("fill", "#2e3436");	

		y+=200;
		var secondLayer = svg.append("g");
		var firstCol 	= secondLayer.append("svg")
			.attr("x", x)
			.attr("y", y)
			.attr("width", 350)
			.attr("height", 250);		
		console.log(firstCol)
		nv.addGraph(function() {
			var chart = nv.models.discreteBarChart()
				.x(function(d) { return d.label })
				.y(function(d) { return d.value })
				.staggerLabels(true)
				.tooltips(false)
				.showValues(true)
				.width(350)
				.height(200)

			chart.yAxis
				.tickFormat(d3.format('$,'));

			var data = {key:"Revenue", values:[]};
			console.log(data);
			for (var i in incomeStat){
				data.values.push({
					label: incomeStat[i].period,
					value: parseInt(incomeStat[i].TotalRevenue.content)
				});
			}
			firstCol.datum([data])
				.transition().duration(500)
				.call(chart);

			nv.utils.windowResize(chart.update);

			return chart;
		});

		var thridLayer = svg.append("g");
	});


});
function constructQueryDate(year, month, date){
	return year + "-"+(month>=10? month:("0"+month)) + "-"+ (date>=10? date:("0"+date));p
}
function parsePercent(str){
	return parseFloat(str.slice(0, -1));
}
function parseDate(str){
	var month = -1;
	switch (str.slice(0, 2)){
		case "Jan": 	month = 0;	break;
		case "Feb": 	month = 1;	break;
		case "Mar": 	month = 2;	break;
		case "Apr": 	month = 3;	break;
		case "May": 	month = 4;	break;
		case "Jun": 	month = 5;	break;
		case "Jul": 	month = 6;	break;
		case "Aug": 	month = 7;	break;
		case "Sep": 	month = 8;	break;
		case "Oct": 	month = 9;	break;
		case "Nov": 	month = 10;	break;
		case "Dec": 	month = 11;	break;

	} 
	var date = parseInt(str.slice(3));
	return {month: month, date: day};
}
function toQueryString(obj) {      
  var parts = [];      
  for(var each in obj) if (obj.hasOwnProperty(each)) {  
    parts.push(encodeURIComponent(each) + '=' + encodeURIComponent(obj[each]));      
  }      
  return parts.join('&');    
}; 	
var runQuery = function(ws_base_uri,query, handler) {  
	var url = ws_base_uri + toQueryString({q: query, format: 'json', env: 'store://datatables.org/alltableswithkeys'});
	console.log(url)
	return $.ajax({
		type: "GET",
		url:url,
		dataType: "json"
	}).then(handler);

	//$.getJSON(url, handler)   
}; 
</script>
</head>
<body>
	<div id="chart">
  <svg></svg>
</div>

	<div class="container">
		<div class="report"></report>
	</div>
</body>
</html>